<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0"
    xml:id="Hyper-V">
    <?dbhtml stop-chunking?>
    <title>Hyper-V</title>
<para>It is posible to use Hyper-V as a compute node within an OpenStack Deployment.  The Nova-compute api runs as a 
        32bit service directly upon the Windows platform with the Hyper-V role enabled. The necessary Python components
        as well as the nova-compute service are installed directly onto the Windows Platform. Windows Clustering Services are 
        not needed for functionality within the OpenStack infrastructure. The use of the Windows Server 2012 platform is 
        recommend for the best experience and is the platform for active develpment. 
        
        The following Windows platforms have been tested as compute nodes:<itemizedlist>
            <listitem>
                <title>Windows Server 2008r2</title>
                <para>Both Server and Server Core with the Hyper-V role enabled (Live migration is not supported)</para>
            </listitem>
            <listitem>
                <title>Windows Server 2012</title>
                <para>Server and Core (with the Hyper-V role enabled), and Hyper-V Server</para>
            </listitem>
        </itemizedlist>
</para>
    <section xml:id="installation-architecture"><title>Hyper-V Configuration</title>
<para>The following sections will discuss the how to prepare the Windows Hyper-V node for
            operation as an Openstack Compute node. Unless stated otherwise, any configuration
            information should work for both the Windows 2008r2 and 2012 platforms.
        <title>Local Storage Considerations</title>
        <para>The Hyper-V compute node needs to have ample storage for storing the virtual
            machine images running on the compute nodes. You may use a sinlge volume for all, or
            partition it into an OS volume and VM volume. It is up to the individual deploying to
            decide.</para>
        <title>Configure NTP</title>
        <para>Network time services must be configured to ensure proper operation of the Hyper-V
            compute node. To set network time on your Hyper-V host you will need to run the
            following commands</para>
        <screen os="windows">
            <prompt>C:\</prompt><userinput>net stop w32time</userinput>
        </screen>
        <screen os="windows">
            <prompt>C:\</prompt><userinput>w32tm /config /manualpeerlist:pool.ntp.org,0x8 /syncfromflags:MANUAL</userinput>
        </screen>
        <screen os="windows">
            <prompt>C:\</prompt><userinput>net start w32time</userinput>
        </screen>
        <title>Configuring Your Hyper-V Bridge</title>
    <title>Enable iSCSI Initator Service</title>
    <para>To prepare the Hyper-V node to be able to attach to volumes provided by nova-volume
        or cinder you must first make sure the Windows iSCSI initiator service is running and started automatically.</para>
    <screen os="windows">
            <prompt>C:\</prompt><userinput>sc start MSiSCSI</userinput>
        </screen>
    <screen os="windows">
            <prompt>C:\</prompt><userinput>sc config MSiSCSI start="auto"</userinput>
        </screen>

</para>
        
        <title>Configuring Shared Nothing Live Migration</title>
        <para>Detailed information on the configuration of live migration can be found here:
            <link
                xlink:href="http://technet.microsoft.com/en-us/library/jj134199.aspx"
                >http://technet.microsoft.com/en-us/library/jj134199.aspx</link></para>
            <para>The following outlines the steps of shared nothing live migration.
            <itemizedlist>
                <listitem><para>1) The target hosts ensures that live migration is enabled and properly
                    configured in Hyper-V.</para></listitem>
                <listitem><para>2) The target hosts checks if the image to be migrated requires a base VHD
                    and pulls it from Glance if not already available on the target host.</para></listitem>
                <listitem><para>3) The source hosts ensures that live migration is enabled and properly
                    configured in Hyper-V</para></listitem>
                <listitem><para>4) The source hosts initialtes a Hyper-V live migration</para></listitem>
                <listitem><para>5) The source hosts communicates to the manager the outcome of the
                    operation</para></listitem>
            </itemizedlist> 
            </para>
                
            <para>The following two configuration options/flags are needed in order to support Hyper-V
            live migration and must be added to your nova.conf on the Hyper-V compute node:<itemizedlist>
                <listitem>
                    <literal>instances_shared_storage=False</literal>
                    <para>This needed to support "shared nothing" Hyper-V live migrations. It is
                        used in nova/compute/manager.py</para>
                </listitem>
                <listitem>
                    <literal>limit_cpu_features=True</literal>
                    <para>This flag is needed to support live migration to hosts with different CPU
                        features. This flag is checked during instance creation in order to limit
                        the CPU features used by the VM.</para>
                </listitem>
                <listitem>
                    <literal>instances_path=DRIVELETTER:\PATH\TO\YOUR\INSTANCES</literal>
                </listitem>
            </itemizedlist>
            </para>
            Additional Requirements:<itemizedlist>
                <listitem>
                    <para>Hyper-V 2012 RC or Windows Server 2012 RC with Hyper-V role enabled</para>
                </listitem>
                <listitem>
                    <para>A Windows domain controller with the Hyper-V compute nodes as domain members</para>
                </listitem>
                <listitem>
                    <para>The instances_path command line option/flag needs to be the the same on
                        all hosts</para>
                </listitem>
                <listitem>
                    <para>The openstack-compute service deployed with the setup must run with
                        domain credentials. You can set the service credentials with: sc config openstack-compute
                        obj="DOMAIN\username" password="password".</para>
                </listitem>
            </itemizedlist>
            <title>How to setup live migration on Hyper-V</title>
            <para>To enable shared nothing live migration run the 3 Powershell instructions below on each
                Hyper-V host:</para>
            <screen os="windows">
            <prompt>PS C:\</prompt><userinput>Enable-VMMigration</userinput>
            </screen>
                <screen os="windows">
            <prompt>PS C:\</prompt><userinput>Set-VMMigrationNetwork 192.168.10.1</userinput>
                </screen>
                <screen os="windows">
            <prompt>PS C:\</prompt><userinput>Set-VMHost –VirtualMachineMigrationAuthenticationType
                    Kerberos</userinput>
                </screen>


            <title>Additional Reading</title>
            <para>Here's an article that clarifies very well the various live migration options in
                Hyper-V:</para>
            <link
                xlink:href="http://ariessysadmin.blogspot.ro/2012/04/hyper-v-live-migration-of-windows.html"
                >http://ariessysadmin.blogspot.ro/2012/04/hyper-v-live-migration-of-windows.html</link>
        
</section>
 <section xml:id="python-requirements"><title>"Installation Requirements"></title>
     <para></para>
        <title>Python 2.7.3</title>
        <para>Python 2.7.3 must be installed prior to installing the OpenStack Compute Driver on the Hyper-V server.  Download and then install the MSI for windows here:<itemizedlist>
             <listitem>
                 <link xlink:href="http://www.python.org/ftp/python/2.7.3/python-2.7.3.msi" >http://www.python.org/ftp/python/2.7.3/python-2.7.3.msi</link>
             </listitem>
             <listitem>Install the MSI accepting the default options.</listitem>
             <listitem>The installation will put python in C:/python27.</listitem>
         </itemizedlist>
        </para>
    <title>Setuptools-0.6c11.win32-py2.7</title>
        <para>You will require pip to install the necessary python module dependencies.  The installer will install under the C:\python27 directory structure. Setuptools for Python 2.7 for Windows can be download from here:</para>
        <link xlink:href="http://pypi.python.org/packages/2.7/s/setuptools/setuptools-0.6c11.win32-py2.7.exe#md5=57e1e64f6b7c7f1d2eddfc9746bbaf20">
            http://pypi.python.org/packages/2.7/s/setuptools/setuptools-0.6c11.win32-py2.7.exe
        </link>
        <para></para>

        <title>Python Dependencies</title>
        <para>The following packages need to be downloaded and manually installed</para>
        <itemizedlist>
            <listitem><title>M2Crypto==0.21.1</title> 
                <para>Download and run the installer from the following location:</para>
                <link xlink:href="http://chandlerproject.org/pub/Project/MeTooCrypto/M2Crypto-0.21.1.win32-py2.7.exe">http://chandlerproject.org/pub/Project/MeTooCrypto/M2Crypto-0.21.1.win32-py2.7.exe</link>
            </listitem>
            
            <listitem><title>MySQL-python==1.2.3</title>
                <link xlink:href="http://codegood.com/download/10/">http://codegood.com/download/10/</link>
            </listitem>

            <listitem><title>pywin32==217</title>
                <para>Download and run the installer from the following location</para>
                <link xlink:href="http://sourceforge.net/projects/pywin32/files/pywin32/Build%20217/pywin32-217.win32-py2.7.exe">http://sourceforge.net/projects/pywin32/files/pywin32/Build%20217/pywin32-217.win32-py2.7.exe</link>
            </listitem>
            
            <listitem><title>greenlet==0.3.4</title>
                <para>Select the link below:</para>
                <link xlink:href="http://www.lfd.uci.edu/~gohlke/pythonlibs/">http://www.lfd.uci.edu/~gohlke/pythonlibs/</link>
                <para>You will need to scroll down to the greenlet section for the following file:
                    greenlet-0.4.0.win32-py2.7.‌exe</para>
                <para>Click on the file, to initiate the download. Once the download is compelete,
                    run the installer.</para>
            </listitem>
        </itemizedlist>
        
        <para>The following python packages need to be installed via eazy_install or pip.  Running
            c:\Python27\Scripts\pip.exe install "PACKAGENAME" using the packages listed below.
            Please note that you do not need to supply the =="VERSION", it will automatically
            download and install the latest.</para>
        <itemizedlist>
            <listitem>SQLAlchemy==0.7.8</listitem>
            <listitem>WebOb==1.0.8</listitem>
            <listitem>amqplib==1.0.2</listitem>
            <listitem>anyjson==0.3.1</listitem>
            <listitem>argparse==1.2.1</listitem>
            <listitem>boto==2.1.1</listitem>
            <listitem>carrot==0.10.7</listitem>
            <listitem>cheetah==2.4.4</listitem> 
            <listitem>decorator==3.3.3</listitem>
            <listitem>docutils==0.9</listitem>
            <listitem>eventlet==0.9.16</listitem>
            <listitem>feedparser==5.1.2</listitem>
            <listitem>glance==2012.2</listitem>
            <listitem>httplib2==0.7.4</listitem>
            <listitem>ipython==0.12.1</listitem>
            <listitem>iso8601==0.1.4</listitem>
            <listitem>jinja2==2.6</listitem>
            <listitem>kombu==2.2.0</listitem>
            <listitem>lockfile==0.9.1</listitem>
            <listitem>logilab-astng==0.23.1</listitem>
            <listitem>logilab-common==0.57.1</listitem>
            <listitem>lxml==2.3.5</listitem>
            <listitem>markdown==2.1.1</listitem>
            <listitem>mox==0.5.3</listitem>
            <listitem>netaddr==0.7.7</listitem>
            <listitem>nose==1.1.2</listitem>
            <listitem>pastedeploy==1.5.0</listitem>
            <listitem>pep8==1.2</listitem>
            <listitem>prettytable==0.6.1</listitem>
            <listitem>pygments==1.5</listitem>
            <listitem>pylint==0.25.1</listitem>
            <listitem>python-novaclient==2012.1</listitem>
            <listitem>repoze.lru==0.5</listitem>
            <listitem>routes==1.13</listitem>
            <listitem>sphinx==1.1.3</listitem>
            <listitem>sqlalchemy-migrate==0.7.2</listitem>
            <listitem>suds==0.4</listitem>
            <listitem>tempita==0.5.1</listitem>
            <listitem>wmi==1.4.9</listitem>
            <listitem>wsgiref==0.1.2</listitem>
            <listitem>python-cinderclient</listitem>
        </itemizedlist>
    </section>

    
    <title>Installing Nova-compute from source</title>
    <section>
        <title>Using git on Windows to retrieve source</title>
        <para></para>
    </section>
    
    <section>
        <title>Configuring Nova.conf</title>
        <para></para>
    </section>
    
    <title>Preparing Images for use with Hyper-V</title>
    <para>Hyper-V currently supports only the vhd file format for Virtual machine instances.</para>
    <title>Running Compute with Hyper-V</title>
    <title>Troubleshooting Hyper-V Configuration</title>


    <!--
    <title>Configuring OpenStack with Hyper-V</title>
    <para>You can run OpenStack Compute with Hyper-V as the hypervisor to run Windows 2008 R2
        Datacenter or Enterprise virtual instances. </para>   
    <section>
        <title>Requirements</title>
        <para>Supported Operating System: Windows 2008 R2 Datacenter or Enterprise (Note that licensing is limited on Enterprise.)</para>
        
        <para>On the Compute node that is running Windows, install the following
            dependencies.</para>
        <itemizedlist>
        <listitem>
        <para>Python 2.6 (32 bit): 
        <link xlink:href="http://www.python.org/download/releases/2.6.6/">http://www.python.org/download/releases/2.6.6/</link>
        </para>
        </listitem>
            <listitem><para>Microsoft Visual C++ 2008 Redistributable Package: <link xlink:href="http://www.microsoft.com/downloads/en/details.aspx?familyid=9B2DA534-3E03-4391-8A4D-074B9F2BC1BF">http://www.microsoft.com/downloads/en/details.aspx?familyid=9B2DA534-3E03-4391-8A4D-074B9F2BC1BF</link></para></listitem>
            <listitem><para>easy_install: <link xlink:href="http://pypi.python.org/pypi/setuptools#files">http://pypi.python.org/pypi/setuptools#files</link></para></listitem>
            <listitem><para>Pywin32 214<link
                        xlink:href="http://sourceforge.net/projects/pywin32/files/pywin32/Build%20214/pywin32-214.win32-py2.6.exe/download"
                        >http://sourceforge.net/projects/pywin32/files/pywin32/Build%20214/pywin32-214.win32-py2.6.exe/download</link></para></listitem>
            <listitem><para>Swig 2.0.1:<link xlink:href="http://sourceforge.net/projects/swig/"> http://sourceforge.net/projects/swig/</link></para></listitem>
            <listitem><para>M2Crypto 0.19.1 <link xlink:href="http://chandlerproject.org/pub/Projects/MeTooCrypto/M2Crypto-0.19.1.win32-py2.6.exe">http://chandlerproject.org/pub/Projects/MeTooCrypto/M2Crypto-0.19.1.win32-py2.6.exe</link></para></listitem>
            <listitem><para>MySQL-python 1.2.2: <link xlink:href="http://www.codegood.com/archives/4">http://www.codegood.com/archives/4</link></para></listitem>
        </itemizedlist>
        
        <para>Use easy_install to install the following additional requirements:</para>
        
        
        <itemizedlist>
        <listitem><para>pip</para></listitem>
        <listitem><para>netaddr</para></listitem>
        <listitem><para>paramiki</para></listitem>
        <listitem><para>WMI 1.4.7</para></listitem> 
        <listitem><para>IPy 0.72</para></listitem>
        <listitem><para>Markdown 2.0.3</para></listitem>
        <listitem><para>SQLAlchemy 0.6.5</para></listitem>
        <listitem><para>Twisted 10.2.0</para></listitem>
        <listitem><para>amqplib 0.6.1</para></listitem>
        <listitem><para>anyjson 0.3</para></listitem>
        <listitem><para>boto 1.9b</para></listitem>
        <listitem><para>carrot 0.10.7</para></listitem>
        <listitem><para>eventlet 0.9.13</para></listitem>
        <listitem><para>greenlet 0.3.1</para></listitem>
        <listitem><para>mox 0.5.3</para></listitem>
        <listitem><para>python-gflags 1.4</para></listitem>
        <listitem><para>tornado 1.1</para></listitem>
        <listitem><para>zope.interface 3.6.1</para></listitem></itemizedlist>
        
    </section>       
    <section><title>Installation Architecture</title><para>With Hyper-V integration, the nova-compute service runs on a Windows server and the remaining nova- services run on Linux servers.</para></section>
    
    <section><title>Configuring OpenStack Compute (Nova) to use Hyper-V</title><para>Configure Windows Server for the Compute Node </para>
        <para>Install Dependencies </para>
        <para>Setting up the Nova Environment </para>
        <para>Configure nova.conf flags for Hyper-V</para></section>
    
    <section><title>Running Nova with Hyper-V</title><para>Managing instances running Hyper-V</para></section>
    
    <section><title>Preparing Images for use with Hyper-V</title>
        <para>Install a new virtual machine on Hyper-V to create a VHD file using <link xlink:href="http://technet.microsoft.com/en-us/library/cc732470%28WS.10%29.aspx#BKMK_step3">instructions from Microsoft</link>. </para>
        <para>The VHD file is usually saved in C:\Users\Public\Documents\Hyper-V\Virtual hard disks.
            If using a local copy (when use_s3=False in your nova.conf), copy this to
            C:\Users\Public\Documents\Hyper-V\Virtual hard disks\images\&lt;image name&gt;\image.
            Note this is "image" not "image.vhd" - no file extension. The VHD file needs to be
            renamed to just "image" in the directory with the name of the image. </para></section>
            -->
</chapter>
